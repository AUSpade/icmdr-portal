<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>iCmdr POC</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b1220;
  --panel:#111827;
  --panel2:#1f2937;
  --accent:#3b82f6;
  --danger:#dc2626;
  --text:#e5e7eb;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  color:var(--text);
}
.login{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  background:var(--panel);
  padding:24px;
  border-radius:12px;
  width:320px;
}
.topbar{
  height:52px;
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 16px;
}
.hamburger{
  font-size:26px;
  cursor:pointer;
}
.menu{
  position:fixed;
  top:52px;
  right:-260px;
  width:260px;
  height:calc(100% - 52px);
  background:var(--panel2);
  padding:16px;
  transition:.25s;
}
.menu.open{right:0;}
.menu button{
  width:100%;
  margin-top:8px;
  padding:10px;
  background:var(--accent);
  border:none;
  border-radius:6px;
  color:white;
}
.screen{display:none;padding:16px;}
.screen.active{display:block;}
input,select{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:6px;
  border:none;
}
.member{
  background:var(--panel2);
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}
.delete-btn{
  background:var(--danger);
}
.shift{
  background:#1e293b;
  padding:6px;
  border-radius:4px;
  margin-top:4px;
  font-size:13px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginScreen">
  <div class="card">
    <h2>Login</h2>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginErr" style="color:#f87171;display:none">Invalid login</p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <div class="topbar">
    <strong>iCmdr – Morwell (POC)</strong>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
  </div>

  <div class="menu" id="menu">
    <h3 id="menuUser"></h3>
    <button onclick="openScreen('profile')">Profile</button>
    <button onclick="openScreen('roster')">Roster</button>
    <div id="adminMenu"></div>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- PROFILE -->
  <div class="screen active" id="profile">
    <h2>Profile</h2>
    <p><strong>Name:</strong> <span id="pName"></span></p>
    <p><strong>Username:</strong> <span id="pUser"></span></p>
    <p><strong>Rank:</strong> <span id="pRank"></span></p>
    <p><strong>Member #:</strong> <span id="pNum"></span></p>

    <h3>This Month Roster (POC)</h3>
    <div id="profileRoster"></div>
  </div>

  <!-- ROSTER -->
  <div class="screen" id="roster">
    <h2>Unit Roster</h2>
    <div id="rosterView"></div>
  </div>

  <!-- ADMIN -->
  <div class="screen" id="admin">
    <h2>Members</h2>

    <div id="createBox" style="display:none">
      <h3>Add Member</h3>
      <input id="addName" placeholder="Full name">
      <input id="addUsername" placeholder="Username">
      <input id="addPassword" placeholder="Password">
      <input id="addNumber" placeholder="Member number">
      <select id="addRank"></select>
      <button onclick="createUser()">Create Member</button>
      <hr>
    </div>

    <div id="memberList"></div>
  </div>

</div>

<script>
const SHIFTS=["Tue-D","Tue-N","Wed-D","Wed-N","Thu-D","Thu-N","Fri-D","Fri-N","Sat-D","Sat-N"];

const RANK_RULES={
  "Section Leader":["Member","Section Leader"],
  "Deputy Controller":["Member","Section Leader"],
  "Controller":["Member","Section Leader","Deputy Controller"],
  "Staff":["Member","Section Leader","Deputy Controller","Controller"],
  "Super Admin":["Member","Section Leader","Deputy Controller","Controller","Staff","Super Admin"]
};

const DELETE_ALLOWED=["Controller","Staff","Super Admin"];

let users=JSON.parse(localStorage.getItem("users"))||{
  admin:{
    username:"admin",
    name:"Aaron Robbins",
    pass:"admin",
    rank:"Super Admin",
    num:"33",
    roster:{}
  }
};

let currentUser="";

function save(){localStorage.setItem("users",JSON.stringify(users));}
function toggleMenu(){menu.classList.toggle("open");}

function openScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  menu.classList.remove("open");
  if(id==="admin")renderAdmin();
  if(id==="roster")renderRoster();
}

function login(){
  const u=loginUser.value,p=loginPass.value;
  const user=Object.values(users).find(x=>x.username===u&&x.pass===p);
  if(user){
    currentUser=user.username;
    menuUser.innerText=`${user.num} ${user.name}`;
    pName.innerText=user.name;
    pUser.innerText=user.username;
    pRank.innerText=user.rank;
    pNum.innerText=user.num;
    loginScreen.style.display="none";
    app.style.display="block";
    if(user.rank!=="Member"){
      adminMenu.innerHTML='<button onclick="openScreen(`admin`)">Admin</button>';
    } else adminMenu.innerHTML="";
    renderProfileRoster();
  } else loginErr.style.display="block";
}

function logout(){
  currentUser="";
  app.style.display="none";
  loginScreen.style.display="flex";
  menu.classList.remove("open");
}

function renderProfileRoster(){
  profileRoster.innerHTML="";
  SHIFTS.forEach(s=>{
    profileRoster.innerHTML+=`<div class="shift">${s}: ${users[currentUser].roster[s]||"—"}</div>`;
  });
}

function renderRoster(){
  rosterView.innerHTML="";
  Object.values(users).forEach(u=>{
    rosterView.innerHTML+=`
      <div class="member">
        <strong>${u.num} ${u.name}</strong> (${u.rank})
      </div>`;
  });
}

function renderAdmin(){
  const me=users[currentUser];
  memberList.innerHTML="";
  const canAdd=me.rank!=="Member"&&me.rank!=="Section Leader";
  createBox.style.display=canAdd?"block":"none";
  if(canAdd){
    addRank.innerHTML="";
    (RANK_RULES[me.rank]||[]).forEach(r=>addRank.innerHTML+=`<option>${r}</option>`);
  }

  Object.values(users).forEach(u=>{
    memberList.innerHTML+=`
      <div class="member">
        <strong>${u.num} ${u.name}</strong><br>
        Username: ${u.username}<br>
        Rank: ${u.rank}<br>
        ${me.rank==="Section Leader"?"":`<button onclick="editUser('${u.username}')">Edit</button>`}
        ${DELETE_ALLOWED.includes(me.rank)&&u.username!==currentUser?`<button class="delete-btn" onclick="deleteUser('${u.username}')">Delete</button>`:""}
      </div>`;
  });
}

function editUser(username){
  const me=users[currentUser];
  const u=users[username];
  const allowed=RANK_RULES[me.rank]||[];
  const allowRankEdit = me.rank==="Super Admin" || username!==currentUser;

  memberList.innerHTML=`
    <div class="member">
      Name <input id="eName" value="${u.name}">
      Member # <input id="eNum" value="${u.num}">
      Username <input id="eUser" value="${u.username}">
      Password <input id="ePass" value="${u.pass}">
      Rank
      <select id="eRank" ${allowRankEdit?"":"disabled"}>
        ${allowed.map(r=>`<option ${u.rank===r?"selected":""}>${r}</option>`).join("")}
      </select>
      <button onclick="saveEdit('${username}')">Save</button>
    </div>`;
}

function saveEdit(originalKey){
  const newUser=document.getElementById("eUser").value.trim();
  const updated={
    username:newUser,
    name:eName.value,
    num:eNum.value,
    pass:ePass.value,
    rank:eRank.value,
    roster:users[originalKey].roster||{}
  };
  delete users[originalKey];
  users[newUser]=updated;
  save();
  renderAdmin();
}

function deleteUser(username){
  if(!confirm("Delete this member?"))return;
  delete users[username];
  save();
  renderAdmin();
}

function createUser(){
  if(!addUsername.value)return alert("Username required");
  if(users[addUsername.value])return alert("Username exists");
  users[addUsername.value]={
    username:addUsername.value,
    name:addName.value,
    pass:addPassword.value,
    rank:addRank.value,
    num:addNumber.value,
    roster:{}
  };
  save();
  addName.value=addUsername.value=addPassword.value=addNumber.value="";
  renderAdmin();
}
</script>

</body>
</html>
